{% extends 'base.html' %}
{% block title %} {{ title }} {% endblock %}
{% block content %}
<div class="sample-buttons-container">
    <button class="collapse-button">
    Collapse all
    </button>
    <button class="export-button">
    Export as
    </button>
    <button class="newsample-button" onclick="window.location.href='/'">
    Make a new sample!
    </button>
</div>
<h3 style="text-align: center">
{{ title }}
</h3>

<h5 style="text-align: center;"><strong>Total languages:</strong> {{ total_languages }} | <strong>Total genera:</strong> {{ total_genera }}</h5>
<br>
{% if total_languages < sampleSize %}
<p style="text-align: center;">The actual size of a sample is less than expected. Unfortunately, the sample of {{ sampleSize }} languages is not possible with chosen filters.</p>
{% endif %}

{% if feature_info %}
<div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
    <h5 style="text-align: center;"><strong style="text-align: center">Filtered by features:</strong></h5>
    <br>
    <ul style="list-style: none; padding: 0; margin: 10px 0 0 0;">
    {% for feature_code, info in feature_info.items() %}
        <li style="margin: 5px 0;">
            <strong>{{ info.name }}</strong> ({{ feature_code }}, {{ info.source }}): 
            <em>{{ info.value_names|join(', ') }}</em>
        </li>
    {% endfor %}
    </ul>
</div>
{% endif %}

<div class="accordion" id="accordionPanelsStayOpenExample">
    {% for macroarea, languages in languages_by_macroarea.items() %}
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button {% if loop.index0 != 0 %}collapsed{% endif %}" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#panelsStayOpen-collapse{{ loop.index }}" 
                    aria-expanded="{% if loop.index0 == 0 %}true{% else %}false{% endif %}" 
                    aria-controls="panelsStayOpen-collapse{{ loop.index }}">
                {{ macroarea }} ({{ languages|length }} languages)
            </button>
        </h2>
        <div id="panelsStayOpen-collapse{{ loop.index }}" 
             class="accordion-collapse collapse {% if loop.index0 == 0 %}show{% endif %}">
            <div class="accordion-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Language</th>
                            <th scope="col">Glottocode</th>
                            <th scope="col">ISO</th>
                            <th scope="col">Genus</th>
                            <th scope="col">Coordinates</th>
                            <th scope="col">Sources</th>
                            {% if has_doc_lang_filter %}
                                <th scope="col">Documentation Languages</th>
                            {% endif %}
                            {% if all_feature_codes %}
                                {% for feature_code in all_feature_codes %}
                                    {% if feature_info[feature_code].source == "WALS" %}
                                        <th scope="col">{{ feature_info[feature_code].name }} <a href="https://wals.info/feature/{{ feature_code }}">({{ feature_code }})</a></th>
                                    {% endif %}
                                    {% if feature_info[feature_code].source == "Grambank" %}
                                        <th scope="col">{{ feature_info[feature_code].name }} <a href="https://grambank.clld.org/parameters/{{ feature_code }}">({{ feature_code }})</a></th>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for lang in languages %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td><strong>{{ lang.name }}</strong></td>
                            <td><code>{{ lang.glottocode }}</code></td>
                            <td>{{ lang.iso if lang.iso else '-' }}</td>
                            <td>{{ lang.genus }}</td>
                            <td>
                                {% if lang.latitude and lang.longitude %}
                                    {{ lang.latitude }}, {{ lang.longitude }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if lang.sources %}
                                    <ul style="margin: 0; padding-left: 20px; list-style-type: disc;">
                                        {% for source in lang.sources %}
                                            <li style="margin-bottom: 4px;">{{ source }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            {% if has_doc_lang_filter %}
                                <td>
                                    {% if lang.doc_languages %}
                                        <span title="Documentation languages">{{ lang.doc_languages|join(', ') }}</span>
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                            {% endif %}
                            {% if all_feature_codes %}
                                {% for feature_code in all_feature_codes %}
                                    <td>
                                        {% if feature_code in lang.features %}
                                            <span title="{{ lang.features[feature_code].value_code }}">
                                                {{ lang.features[feature_code].value_name.capitalize() }}
                                            </span>
                                        {% else %}
                                            <span style="color: #999;">-</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
// Функция для сворачивания/разворачивания всех аккордеонов
document.querySelector('.collapse-button').addEventListener('click', function() {
    const allCollapses = document.querySelectorAll('.accordion-collapse');
    const allButtons = document.querySelectorAll('.accordion-button');
    
    // Проверяем состояние первого элемента
    const firstCollapse = allCollapses[0];
    const isShown = firstCollapse.classList.contains('show');
    
    allCollapses.forEach(collapse => {
        if (isShown) {
            collapse.classList.remove('show');
        } else {
            collapse.classList.add('show');
        }
    });
    
    allButtons.forEach(button => {
        if (isShown) {
            button.classList.add('collapsed');
            button.setAttribute('aria-expanded', 'false');
        } else {
            button.classList.remove('collapsed');
            button.setAttribute('aria-expanded', 'true');
        }
    });
    
    // Меняем текст кнопки
    this.textContent = isShown ? 'Expand all' : 'Collapse all';
});

// Функция экспорта (заглушка)
document.querySelector('.export-button').addEventListener('click', function() {
    // Собираем данные в CSV формат
    let csv = 'Language,Glottocode,ISO,Genus,Macroarea,Latitude,Longitude,Sources{% if has_doc_lang_filter %},Documentation Languages{% endif %}';
    
    {% if all_feature_codes %}
    {% for feature_code in all_feature_codes %}
    csv += ',{{ feature_info[feature_code].name }} ({{ feature_code }})';
    {% endfor %}
    {% endif %}
    
    csv += '\n';
    
    {% for macroarea, languages in languages_by_macroarea.items() %}
    {% for lang in languages %}
    csv += '"{{ lang.name }}","{{ lang.glottocode }}","{{ lang.iso if lang.iso else '' }}","{{ lang.genus }}","{{ macroarea }}","{{ lang.latitude if lang.latitude else '' }}","{{ lang.longitude if lang.longitude else '' }}","{{ lang.sources|join('; ') if lang.sources else '' }}"{% if has_doc_lang_filter %},"{{ lang.doc_languages|join('; ') if lang.doc_languages else '' }}"{% endif %}';
    
    {% if all_feature_codes %}
    {% for feature_code in all_feature_codes %}
    {% if feature_code in lang.features %}
    csv += ',"{{ lang.features[feature_code].value_name }}"';
    {% else %}
    csv += ',""';
    {% endif %}
    {% endfor %}
    {% endif %}
    
    csv += '\n';
    {% endfor %}
    {% endfor %}
    
    // Создаем Blob и скачиваем
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', '{{ title }}_sample.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
{% endblock %}