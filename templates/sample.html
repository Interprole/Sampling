{% extends 'base.html' %}
{% block title %} {{ title }} {% endblock %}
{% block content %}
<script>
    window.SAMPLE_DATA = {{ sample_data_json | safe }};
    window.META_DATA = {{ meta_data_json | safe }};
</script>

<div class="sample-buttons-container">
    <button class="collapse-button">
    Collapse all
    </button>
    <button class="export-button-csv">
    Export sample as <code>.csv</code> & <br>metadata as <code>.json</code>
    </button>
    <button class="export-button-xlsx">
        Export sample & metadata<br>as <code>.xlsx</code>
        </button>
    <button class="newsample-button" onclick="window.location.href='/'">
    Make a new sample!
    </button>
</div>
<h3 style="text-align: center">
{{ title }}
</h3>

<h5 style="text-align: center;"><strong>Total languages:</strong> {{ total_languages }} | <strong>Total genera:</strong> {{ total_genera }}</h5>

<div style="margin: 10px auto; padding: 15px; max-width: 800px; background-color: #dcf8d7; border: 1px solid #A4CA9D; border-radius: 5px;">
    <h5 style="text-align: center;"><strong style="text-align: center">Sample settings</strong></h5>
    <p><strong>Sampling Algorithm</strong>:
        {% if algorithm == "genus-macroarea" %} 
            The Genus-Macroarea sampling method
        {% elif algorithm == "diversity-value" %} 
            The Diversity Value sampling method
        {% elif algorithm == "random" %} 
            A Random Sample
        {% endif %}
    </p>
    <p><strong>Included Macroareas</strong>: 
        {% if macroareas %}
            {{ ', '.join(macroareas) }} 
        {% else %}
            Africa, Australia, Eurasia, North America, Papunesia, South America
        {% endif %}
    </p>
    <p><strong>Sample Size</strong>: {{ sampleSize }} </p>
    {% if feature_info%}
        <h5 style="text-align: center;"><strong style="text-align: center">Filtered by features</strong></h5>
        <ul style="padding: 0; margin: 20px 0 0 15px;">
            {% for feature_code, info in feature_info.items() %}
                <li style="margin: 5px 0;">
                    <strong>{{ info.name }}</strong> ({{ feature_code }}, {{ info.source }}): 
                    <em>{{ info.value_names|join(', ') }}</em>
                </li>
            {% endfor %}
        </ul>
        <br>
    {% endif %}
    <h5 style="text-align: center;"><strong style="text-align: center">Search settings</strong></h5>
        {% if includeLang %}
            <p><strong>Included Languages</strong>: {{ ', '.join(includeLang) }} </p>
        {% endif %}
        {% if excludeLang %}
            <p><strong>Excluded Languages</strong>: {{ ', '.join(excludeLang) }} </p>
        {% endif %}
        {% if docLang %}
            <p><strong>Included Descriptions' Languages</strong>: {{ ', '.join(docLang) }} </p>
        {% endif %}
        <p><strong>Select Languages By</strong>:
        {% if ranking_key == 'random' %}
            Random
        {% elif ranking_key == 'descriptive_ranking' %}
            Extensiveness of description (<span>2 &middot;&nbsp;pages + 0.5 &middot;&nbsp;year</span>)
        {% elif ranking_key == 'source_count' %}
            Total number of Descriptions
        {% elif ranking_key == 'year_ranking' %}
            Descriptions' publication year
        {% elif ranking_key == 'pages_ranking' %}
            Descriptions' page count
        {% endif %}
    </p>
    <p><strong>Preference for Descriptions</strong>:
        {% if gramDictPref == -2 %}
            Dictionaries (-2)
        {% elif gramDictPref == -1 %}
            Dictionaries rather than grammars (-1)
        {% elif gramDictPref == 1 %}
            Grammars rather than dictionaries (1)
        {% elif gramDictPref == 2 %}
            Grammars (2)
        {% elif gramDictPref == 0 %}
            Neutral (0)
        {% endif %}
    </p>
</div>

{% if target_macroarea_distribution and actual_macroarea_distribution %}
{% set has_mismatch = namespace(value=False) %}
{% for macroarea, target in target_macroarea_distribution.items() %}
    {% set actual = actual_macroarea_distribution.get(macroarea, 0) %}
    {% set diff = (actual - target) if actual > target else (target - actual) %}
    {% if diff > 1 %}
        {% set has_mismatch.value = True %}
    {% endif %}
{% endfor %}
{% if has_mismatch.value or total_languages != sampleSize %}
<div style="margin: 10px auto; padding: 15px; max-width: 800px; background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
    {% if total_languages != sampleSize %}
        <p style="margin: 0; text-align: center;"><strong>⚠️ Sample Size mismatch ⚠️ </strong> </p>
        {% if total_languages < sampleSize %}
            <p style="text-align: center;">The resulting sample size ({{ total_languages }}) is smaller than what was queried for ({{ sampleSize }}) due to chosen filters.</p>
        {% endif %}
        {% if total_languages > sampleSize %}
            <p style="text-align: center;">The resulting sample size ({{ total_languages }}) is larger than what was queried for ({{ sampleSize }}) due to chosen filters.</p>
        {% endif %}
    {% endif %}
    
    {% if has_mismatch.value %}
        <p style="margin: 0; text-align: center;"><strong>⚠️ Macroarea distribution mismatch ⚠️ </strong> </p>
        <p style="margin: 0; text-align: center;">The target distribution by macroareas could not be fully achieved with the chosen filters.</p>
        <table style="margin: 10px auto; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="padding: 5px 15px; text-align: left;">Macroarea</th>
                    <th style="padding: 5px 15px; text-align: center;">Target</th>
                    <th style="padding: 5px 15px; text-align: center;">Actual</th>
                    <th style="padding: 5px 15px; text-align: center;">Diff</th>
                </tr>
            </thead>
            <tbody>
            {% for macroarea, target in target_macroarea_distribution.items() %}
                {% set actual = actual_macroarea_distribution.get(macroarea, 0) %}
                {% set diff = (actual - target) if actual > target else (target - actual) %}
                <tr style="background-color: {% if diff <= 1 %}#e3f2fd{% else %}#ffebee{% endif %};">
                    <td style="padding: 5px 15px;">{{ macroarea }}</td>
                    <td style="padding: 5px 15px; text-align: center;">{{ target }}</td>
                    <td style="padding: 5px 15px; text-align: center;">{{ actual }}</td>
                    <td style="padding: 5px 15px; text-align: center;">{{ diff }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>
{% endif %}
{% endif %}
<!-- Карта с языками -->
<div style="margin: 20px 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h5 style="margin: 0;"><strong>Languages Map</strong></h5>
        <div>
            {% if all_feature_codes %}
            <label for="mapFeatureSelect" style="margin-right: 10px; color: #0F3362; font-family: 'Charis SIL';">Color by feature:</label>
            <select id="mapFeatureSelect" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc;">
                <option value="">None (by macroarea)</option>
                {% for feature_code in all_feature_codes %}
                    <option value="{{ feature_code }}">{{ feature_info[feature_code].name }} ({{ feature_code }})</option>
                {% endfor %}
            </select>
            {% endif %}
            <button id="exportMapBtn" style="padding: 5px 15px; margin-left: 10px; border-radius: 5px; border: 1px solid #ccc; background-color: #fff; cursor: pointer;">
                Export Map as PNG
            </button>
        </div>
    </div>
    <div id="languageMap" style="height: 700px; width: 100%; border: 1px solid #ccc; border-radius: 5px;"></div>
    <div id="mapLegend" style="margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; color: #0F3362; font-family: 'Charis SIL'"></div>
</div>

<div class="accordion" id="accordionPanelsStayOpenExample">
    {% for macroarea, languages in languages_by_macroarea.items() %}
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button {% if loop.index0 != 0 %}collapsed{% endif %}" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#panelsStayOpen-collapse{{ loop.index }}" 
                    aria-expanded="{% if loop.index0 == 0 %}true{% else %}false{% endif %}" 
                    aria-controls="panelsStayOpen-collapse{{ loop.index }}">
                {{ macroarea }} ({{ languages|length }} languages)
            </button>
        </h2>
        <div id="panelsStayOpen-collapse{{ loop.index }}" 
             class="accordion-collapse collapse {% if loop.index0 == 0 %}show{% endif %}">
            <div class="accordion-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Language</th>
                            <th scope="col">Glottocode</th>
                            <th scope="col">ISO</th>
                            <th scope="col">Genus</th>
                            <th scope="col">Coordinates</th>
                            <th scope="col">Sources</th>
                            {% if has_doc_lang_filter %}
                                <th scope="col">Documentation Languages</th>
                            {% endif %}
                            {% if all_feature_codes %}
                                {% for feature_code in all_feature_codes %}
                                    {% if feature_info[feature_code].source == "WALS" %}
                                        <th scope="col">{{ feature_info[feature_code].name }} <a href="https://wals.info/feature/{{ feature_code }}">({{ feature_code }})</a></th>
                                    {% endif %}
                                    {% if feature_info[feature_code].source == "Grambank" %}
                                        <th scope="col">{{ feature_info[feature_code].name }} <a href="https://grambank.clld.org/parameters/{{ feature_code }}">({{ feature_code }})</a></th>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for lang in languages %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td><strong>{{ lang.name }}</strong></td>
                            <td><code>{{ lang.glottocode }}</code></td>
                            <td>{{ lang.iso if lang.iso else '-' }}</td>
                            <td>{{ lang.genus }}</td>
                            <td>
                                {% if lang.latitude and lang.longitude %}
                                    {{ lang.latitude }}, {{ lang.longitude }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if lang.sources %}
                                        {% if has_doc_lang_filter %}
                                        <details style="width: 300px">
                                            <summary>List of Descriptions (in {{ ', '.join(docLang) }})</summary>
                                                <ul style="margin: 0; padding-left: 20px; list-style-type: disc; width: 300px;">
                                                {% for i in range(lang.sources | length) %}
                                                    {% if lang.sources_languages[i].intersection(docLang) %}
                                                        <li style="margin-bottom: 4px;">
                                                            {{ lang.sources[i][0] }}
                                                        </li>
                                                    {% endif %}
                                                    {% endfor %}
                                                </ul>
                                        </details>
                                        <details style="width: 300px">
                                            <summary>List of Descriptions (in other languages)</summary>
                                                <ul style="margin: 0; padding-left: 20px; list-style-type: disc; width: 300px;">
                                                {% for source in lang.sources %}
                                                    <li style="margin-bottom: 4px;">
                                                        {{ source[0] }}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                        </details>
                                        {% else %}
                                        <details style="width: 300px">
                                            <summary>List of Descriptions</summary>
                                                <ul style="margin: 0; padding-left: 20px; list-style-type: disc; width: 300px;">
                                                {% for source in lang.sources %}
                                                    <li style="margin-bottom: 4px;">
                                                        {{ source[0] }}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                        </details>
                                        {% endif %}
                                {% else %}
                                    <span style="color: #999;">-</span>
                                {% endif %}
                            </td>
                            {% if has_doc_lang_filter %}
                                <td>
                                    {% if lang.doc_languages %}
                                        <span title="Documentation languages">{{ lang.doc_languages|join(', ') }}</span>
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                            {% endif %}
                            {% if all_feature_codes %}
                                {% for feature_code in all_feature_codes %}
                                    <td>
                                        {% if feature_code in lang.features %}
                                            <span title="{{ lang.features[feature_code].value_code }}">
                                                {{ lang.features[feature_code].value_name.capitalize() }}
                                            </span>
                                        {% else %}
                                            <span style="color: #999;">-</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
// Данные языков для карты
const languagesData = [
    {% for macroarea, languages in languages_by_macroarea.items() %}
    {% for lang in languages %}
    {
        name: "{{ lang.name }}",
        glottocode: "{{ lang.glottocode }}",
        iso: "{{ lang.iso if lang.iso else '' }}",
        genus: "{{ lang.genus }}",
        macroarea: "{{ macroarea }}",
        latitude: {{ lang.latitude if lang.latitude else 'null' }},
        longitude: {{ lang.longitude if lang.longitude else 'null' }},
        features: {
            {% for feature_code in all_feature_codes %}
            {% if feature_code in lang.features %}
            "{{ feature_code }}": {
                value_code: "{{ lang.features[feature_code].value_code }}",
                value_name: "{{ lang.features[feature_code].value_name }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
            {% endfor %}
        }
    }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% if not loop.last %},{% endif %}
    {% endfor %}
];

// Цвета для макроареалов
const macroareaColors = {
    'Africa': '#e74c3c',
    'Eurasia': '#3498db',
    'Australia': '#f39c12',
    'North America': '#9b59b6',
    'South America': '#1abc9c',
    'Papunesia': '#e67e22'
};

// Цвета для значений признаков (палитра)
const featureValueColors = [
    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', 
    '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b',
    '#2980b9', '#8e44ad', '#27ae60', '#d35400', '#7f8c8d'
];

let map;
let markersLayer;
let currentFeatureCode = '';

// Инициализация карты
function initMap() {
    map = L.map('languageMap').setView([20, 0], 2);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);
    
    markersLayer = L.markerClusterGroup({
        maxClusterRadius: 20,
        disableClusteringAtZoom: 4,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false
    });
    
    updateMap('');
}

// Обновление карты
function updateMap(featureCode) {
    currentFeatureCode = featureCode;
    markersLayer.clearLayers();
    
    // Собираем уникальные значения для выбранного признака
    let featureValues = new Set();
    if (featureCode) {
        languagesData.forEach(lang => {
            if (lang.features[featureCode]) {
                featureValues.add(lang.features[featureCode].value_name);
            }
        });
    }
    
    // Создаем маппинг значений на цвета
    let valueColorMap = {};
    let colorIndex = 0;
    featureValues.forEach(value => {
        valueColorMap[value] = featureValueColors[colorIndex % featureValueColors.length];
        colorIndex++;
    });
    
    // Добавляем маркеры
    languagesData.forEach(lang => {
        if (lang.latitude && lang.longitude) {
            let color;
            let legendLabel;
            
            if (featureCode && lang.features[featureCode]) {
                color = valueColorMap[lang.features[featureCode].value_name];
                legendLabel = lang.features[featureCode].value_name;
            } else if (featureCode) {
                color = '#95a5a6'; // Серый для отсутствующих данных
                legendLabel = 'No data';
            } else {
                color = macroareaColors[lang.macroarea] || '#95a5a6';
                legendLabel = lang.macroarea;
            }
            
            const marker = L.circleMarker([lang.latitude, lang.longitude], {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            let popupContent = `<strong>${lang.name}</strong><br>`;
            popupContent += `Glottocode: ${lang.glottocode}<br>`;
            if (lang.iso) popupContent += `ISO: ${lang.iso}<br>`;
            popupContent += `Genus: ${lang.genus}<br>`;
            popupContent += `Macroarea: ${lang.macroarea}<br>`;
            
            if (featureCode && lang.features[featureCode]) {
                popupContent += `<br><strong>${featureCode}:</strong> ${lang.features[featureCode].value_name}`;
            }
            
            marker.bindPopup(popupContent);
            markersLayer.addLayer(marker);
        }
    });
    
    map.addLayer(markersLayer);
    
    // Обновляем легенду
    updateLegend(featureCode, valueColorMap);
}

// Обновление легенды
function updateLegend(featureCode, valueColorMap) {
    const legendDiv = document.getElementById('mapLegend');
    let legendHTML = '<strong>Legend:</strong> ';
    
    if (featureCode) {
        for (let [value, color] of Object.entries(valueColorMap)) {
            legendHTML += `<span style="display: inline-block; margin: 0 10px;">
                <span style="display: inline-block; width: 12px; height: 12px; background-color: ${color}; border-radius: 50%; margin-right: 5px;"></span>
                ${value}
            </span>`;
        }
        legendHTML += `<span style="display: inline-block; margin: 0 10px;">
            <span style="display: inline-block; width: 12px; height: 12px; background-color: #95a5a6; border-radius: 50%; margin-right: 5px;"></span>
            No data
        </span>`;
    } else {
        for (let [macroarea, color] of Object.entries(macroareaColors)) {
            legendHTML += `<span style="display: inline-block; margin: 0 10px;">
                <span style="display: inline-block; width: 12px; height: 12px; background-color: ${color}; border-radius: 50%; margin-right: 5px;"></span>
                ${macroarea}
            </span>`;
        }
    }
    
    legendDiv.innerHTML = legendHTML;
}

// Экспорт карты в PNG
function exportMapAsPNG() {
    const mapElement = document.getElementById('languageMap');
    const legendElement = document.getElementById('mapLegend');
    
    // Временно отключаем кластеризацию для экспорта
    const originalLayer = markersLayer;
    map.removeLayer(markersLayer);
    
    // Создаем временный слой без кластеризации
    const tempLayer = L.layerGroup();
    
    // Копируем все маркеры без кластеризации
    languagesData.forEach(lang => {
        if (lang.latitude && lang.longitude) {
            let color;
            
            if (currentFeatureCode && lang.features[currentFeatureCode]) {
                // Находим цвет для значения
                const allValues = new Set();
                languagesData.forEach(l => {
                    if (l.features[currentFeatureCode]) {
                        allValues.add(l.features[currentFeatureCode].value_name);
                    }
                });
                
                const valueColorMap = {};
                let colorIndex = 0;
                allValues.forEach(value => {
                    valueColorMap[value] = featureValueColors[colorIndex % featureValueColors.length];
                    colorIndex++;
                });
                
                color = valueColorMap[lang.features[currentFeatureCode].value_name];
            } else if (currentFeatureCode) {
                color = '#95a5a6';
            } else {
                color = macroareaColors[lang.macroarea] || '#95a5a6';
            }
            
            const marker = L.circleMarker([lang.latitude, lang.longitude], {
                radius: 8,
                fillColor: color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
            
            tempLayer.addLayer(marker);
        }
    });
    
    tempLayer.addTo(map);
    
    // Даем время на рендеринг
    setTimeout(() => {
        // Используем dom-to-image для более точного захвата
        domtoimage.toPng(mapElement, {
            quality: 1,
            bgcolor: '#ffffff',
            width: mapElement.offsetWidth,
            height: mapElement.offsetHeight
        }).then(mapDataUrl => {
            // Теперь захватываем легенду
            domtoimage.toPng(legendElement, {
                quality: 1,
                bgcolor: '#f8f9fa',
                width: legendElement.offsetWidth,
                height: legendElement.offsetHeight
            }).then(legendDataUrl => {
                // Создаем финальный canvas
                const mapImg = new Image();
                const legendImg = new Image();
                
                mapImg.onload = () => {
                    legendImg.onload = () => {
                        const finalCanvas = document.createElement('canvas');
                        const mapHeight = mapElement.offsetHeight;
                        const legendHeight = legendElement.offsetHeight;
                        
                        finalCanvas.width = mapElement.offsetWidth;
                        finalCanvas.height = mapHeight + legendHeight;
                        
                        const ctx = finalCanvas.getContext('2d');
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
                        
                        // Рисуем карту (обрезаем до реального размера)
                        ctx.drawImage(mapImg, 0, 0, mapElement.offsetWidth, mapHeight, 0, 0, mapElement.offsetWidth, mapHeight);
                        
                        // Рисуем легенду
                        ctx.drawImage(legendImg, 0, 0, legendElement.offsetWidth, legendHeight, 0, mapHeight, legendElement.offsetWidth, legendHeight);
                        
                        // Скачиваем
                        const link = document.createElement('a');
                        link.download = '{{ title }}_map.png';
                        link.href = finalCanvas.toDataURL('image/png');
                        link.click();
                        
                        // Возвращаем кластеризацию
                        map.removeLayer(tempLayer);
                        map.addLayer(originalLayer);
                    };
                    legendImg.src = legendDataUrl;
                };
                mapImg.src = mapDataUrl;
            }).catch(error => {
                console.error('Error capturing legend:', error);
                // Возвращаем кластеризацию даже при ошибке
                map.removeLayer(tempLayer);
                map.addLayer(originalLayer);
            });
        }).catch(error => {
            console.error('Error capturing map:', error);
            // Возвращаем кластеризацию даже при ошибке
            map.removeLayer(tempLayer);
            map.addLayer(originalLayer);
        });
    }, 500);
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Функция для сворачивания/разворачивания всех аккордеонов
    document.querySelector('.collapse-button').addEventListener('click', function() {
        const allCollapses = document.querySelectorAll('.accordion-collapse');
        const allButtons = document.querySelectorAll('.accordion-button');
        
        // Проверяем состояние первого элемента
        const firstCollapse = allCollapses[0];
        const isShown = firstCollapse.classList.contains('show');
        
        allCollapses.forEach(collapse => {
            if (isShown) {
                collapse.classList.remove('show');
            } else {
                collapse.classList.add('show');
            }
        });
        
        allButtons.forEach(button => {
            if (isShown) {
                button.classList.add('collapsed');
                button.setAttribute('aria-expanded', 'false');
            } else {
                button.classList.remove('collapsed');
                button.setAttribute('aria-expanded', 'true');
            }
        });
        
        // Меняем текст кнопки
        this.textContent = isShown ? 'Expand all' : 'Collapse all';
    });

    // Функция для экспорта сэмпла в формате .csv и метаданных в формате .json
    document.querySelector('.export-button-csv').addEventListener('click', function() {
        // Забираем данные о сэмпле из json
        const sampleData = window.SAMPLE_DATA;
        const headers = Object.keys(sampleData[0]);

        let csvRows = [];
        csvRows.push(headers.join(","));

        for (const row of sampleData) {
            const values = headers.map(h => {
                let v = row[h];
                v = String(v).replace(/"/g, '""');
                return `"${v}"`;
            });
            csvRows.push(values.join(","));
        }

        const csvContent = csvRows.join("\n");
        const csvBlob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const csvLink = document.createElement('a');
        csvLink.href = URL.createObjectURL(csvBlob);
        csvLink.download = '{{ title }}_sample.csv';
        csvLink.click();

        // Забираем метаданные о сэмпле из json
        const metaData = window.META_DATA;
        const jsonBlob = new Blob([JSON.stringify(metaData, null, 4)], {type: 'application/json' });
        const jsonLink = document.createElement('a');
        jsonLink.href = URL.createObjectURL(jsonBlob);
        jsonLink.download = '{{ title }}_metadata.json';
        jsonLink.click();
    });

    // Функция для экспорта сэмпла в формате .xlsx
    document.querySelector('.export-button-xlsx').addEventListener('click', function() {
        // Забираем данные о сэмпле из json
        const metaData = window.META_DATA;
        const sampleData = window.SAMPLE_DATA;

        // Создаем файл
        const book = XLSX.utils.book_new();

        // Лист с метаданными
        const meta_data_by_rows = Object.entries(metaData).map(([key, value]) => ({
            Parameter: key,
            Value: value
        }));
        const metaSheet = XLSX.utils.json_to_sheet(meta_data_by_rows, {
            header: ["Parameter", "Value"]
        });
        XLSX.utils.book_append_sheet(book, metaSheet, "Metadata");

        // Лист с сэмплом
        const headers = Object.keys(sampleData[0]);
        const sampleSheet = XLSX.utils.json_to_sheet(sampleData, {
            header: headers
        });
        XLSX.utils.book_append_sheet(book, sampleSheet, "Sample");

        const excelFile = XLSX.write(book, { bookType: 'xlsx', type: 'array' });
        const excelBlob = new Blob([excelFile], { type: 'application/octet-stream' });
        const excelLink = document.createElement('a');
        excelLink.href = URL.createObjectURL(excelBlob);
        excelLink.download = '{{ title }}_sample.xlsx';
        excelLink.click();
    });

    // Карта
    initMap();
    
    // Обработчик выбора признака
    const featureSelect = document.getElementById('mapFeatureSelect');
    if (featureSelect) {
        featureSelect.addEventListener('change', function() {
            updateMap(this.value);
        });
    }
    
    // Обработчик экспорта
    document.getElementById('exportMapBtn').addEventListener('click', exportMapAsPNG);
});
</script>
{% endblock %}