{% extends 'base.html' %}
{% block title %} {{ title }} {% endblock %}
{% block content %}
<div class="sample-buttons-container">
    <button class="collapse-button">
    Collapse all
    </button>
    <button class="export-button">
    Export as
    </button>
    <button class="newsample-button" onclick="window.location.href='/'">
    Make a new sample!
    </button>
</div>
<h3 style="text-align: center">
{{ title }}
</h3>
<p style="text-align: center">
    <strong>Total languages:</strong> {{ total_languages }} | 
    <strong>Total genera:</strong> {{ total_genera }}
</p>

<div class="accordion" id="accordionPanelsStayOpenExample">
    {% for macroarea, languages in languages_by_macroarea.items() %}
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button {% if loop.index0 != 0 %}collapsed{% endif %}" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#panelsStayOpen-collapse{{ loop.index }}" 
                    aria-expanded="{% if loop.index0 == 0 %}true{% else %}false{% endif %}" 
                    aria-controls="panelsStayOpen-collapse{{ loop.index }}">
                {{ macroarea }} ({{ languages|length }} languages)
            </button>
        </h2>
        <div id="panelsStayOpen-collapse{{ loop.index }}" 
             class="accordion-collapse collapse {% if loop.index0 == 0 %}show{% endif %}">
            <div class="accordion-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Language</th>
                            <th scope="col">Glottocode</th>
                            <th scope="col">ISO</th>
                            <th scope="col">Genus</th>
                            <th scope="col">Coordinates</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lang in languages %}
                        <tr>
                            <th scope="row">{{ loop.index }}</th>
                            <td><strong>{{ lang.name }}</strong></td>
                            <td><code>{{ lang.glottocode }}</code></td>
                            <td>{{ lang.iso if lang.iso else '-' }}</td>
                            <td>{{ lang.genus }}</td>
                            <td>
                                {% if lang.latitude and lang.longitude %}
                                    {{ lang.latitude }}, {{ lang.longitude }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<style>
.sample-buttons-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 20px 0;
}

.sample-buttons-container button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.collapse-button {
    background-color: #6c757d;
    color: white;
}

.collapse-button:hover {
    background-color: #5a6268;
}

.export-button {
    background-color: #28a745;
    color: white;
}

.export-button:hover {
    background-color: #218838;
}

.newsample-button {
    background-color: #007bff;
    color: white;
}

.newsample-button:hover {
    background-color: #0056b3;
}

.table {
    margin-top: 15px;
}

.accordion-body {
    padding: 15px;
}
</style>

<script>
// Функция для сворачивания/разворачивания всех аккордеонов
document.querySelector('.collapse-button').addEventListener('click', function() {
    const allCollapses = document.querySelectorAll('.accordion-collapse');
    const allButtons = document.querySelectorAll('.accordion-button');
    
    // Проверяем состояние первого элемента
    const firstCollapse = allCollapses[0];
    const isShown = firstCollapse.classList.contains('show');
    
    allCollapses.forEach(collapse => {
        if (isShown) {
            collapse.classList.remove('show');
        } else {
            collapse.classList.add('show');
        }
    });
    
    allButtons.forEach(button => {
        if (isShown) {
            button.classList.add('collapsed');
            button.setAttribute('aria-expanded', 'false');
        } else {
            button.classList.remove('collapsed');
            button.setAttribute('aria-expanded', 'true');
        }
    });
    
    // Меняем текст кнопки
    this.textContent = isShown ? 'Expand all' : 'Collapse all';
});

// Функция экспорта (заглушка)
document.querySelector('.export-button').addEventListener('click', function() {
    // Собираем данные в CSV формат
    let csv = 'Language,Glottocode,ISO,Genus,Macroarea,Latitude,Longitude\n';
    
    {% for macroarea, languages in languages_by_macroarea.items() %}
    {% for lang in languages %}
    csv += '"{{ lang.name }}","{{ lang.glottocode }}","{{ lang.iso if lang.iso else '' }}","{{ lang.genus }}","{{ macroarea }}","{{ lang.latitude if lang.latitude else '' }}","{{ lang.longitude if lang.longitude else '' }}"\n';
    {% endfor %}
    {% endfor %}
    
    // Создаем Blob и скачиваем
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', '{{ title }}_sample.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});
</script>
{% endblock %}